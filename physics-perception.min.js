// Copyright Erik Weitnauer 2014.
StabilityAttribute=function(t){this.perceive(t)};StabilityAttribute.prototype.key="stability";StabilityAttribute.prototype.targetType="obj";StabilityAttribute.prototype.arity=1;StabilityAttribute.prototype.constant=false;StabilityAttribute.prototype.perceive=function(t){this.obj=t;this.val=this.checkStability(t.phys_obj,t.object_node.scene_node.oracle)};StabilityAttribute.prototype.get_activity=function(){return this.val?1:0};StabilityAttribute.prototype.get_label=function(){if(this.val=="stable"||this.val=="slightly unstable")return"stable";if(this.val=="moving"||this.val=="unstable")return"unstable"};StabilityAttribute.prototype.checkStability=function(t,e){var i=.25;var o=.4;var r=.2;var n=1.047,s=.157;if(e.isStatic(t))return"stable";var a=function(i,a){var p=t.GetAngle();var h=function(){e.applyCentralImpulse(t,i,a?"small":"medium")};return e.analyzeFuture(.3,h,function(){var i=t.m_linearVelocity.Length();var h=a?2/3:1;if(i>=o*h)return false;var l=e.pscene.getBodyDistance(t);if(l>=r*h)return false;var u=Point.norm_angle(t.GetAngle()-p);if(t.IsCircle()&&Math.abs(u)>=n*h||!t.IsCircle()&&Math.abs(u)>=s*h)return false;return true})};var p=t.m_linearVelocity.Length();if(p>i)return"moving";if(a("left",false)&&a("right",false))return"stable";if(a("left",true)&&a("right",true))return"slightly unstable";return"unstable"};MovableUpAttribute=function(t){this.perceive(t)};MovableUpAttribute.prototype.key="can_move_up";MovableUpAttribute.prototype.targetType="obj";MovableUpAttribute.prototype.arity=1;MovableUpAttribute.prototype.constant=false;MovableUpAttribute.prototype.perceive=function(t){this.obj=t;this.val=this.checkMovability("up",t.phys_obj,t.object_node.scene_node.oracle)};MovableUpAttribute.prototype.get_activity=function(){return this.val?1:0};MovableUpAttribute.prototype.get_label=function(){return"can-move-up"};MovableUpAttribute.prototype.checkMovability=function(t,e,i){if(i.isStatic(e))return false;var o=new Box2D.Common.Math.b2Vec2(0,-e.GetMass()*12);var r=function(){e.SetSleepingAllowed(false);e.ApplyForce(o,e.GetWorldCenter())};return i.analyzeFuture(2.5,r,function(){var t=i.getTouchedBodiesWithPos(e);return t.some(function(t){if(t.body.master_obj.id!=="|")return false;for(var e=0;e<t.pts.length;e++){if(t.pts[e].y<.1)return true}})})};ShapeAttribute=function(t){this.perceive(t)};ShapeAttribute.prototype.key="shape";ShapeAttribute.prototype.targetType="obj";ShapeAttribute.prototype.arity=1;ShapeAttribute.prototype.constant=true;ShapeAttribute.prototype.perceive=function(t){this.obj=t;this.val=ShapeAttribute.determineShape(t)};ShapeAttribute.prototype.get_activity=function(){return this.val=="?"?0:1};ShapeAttribute.prototype.get_label=function(){return this.val};ShapeAttribute.determineShape=function(t){if(t instanceof Polygon){if(!t.closed)return"unknown";t.order_vertices();if(t.pts.length==3)return"triangle";if(ShapeAttribute.isRectangle(t)){var e=t.get_edge_lengths(true);if(e[0]/e[3]<.7)return"rectangle";else return"square"}else return"unknown"}else if(t instanceof Circle)return"circle";else return"unknown"};ShapeAttribute.isRectangle=function(t){if(t.pts.length!=4)return false;var e=110*Math.PI/180,i=70*Math.PI/180;for(var o=0;o<t.pts.length;++o){if(t.angle(o)>e||t.angle(o)<i)return false}return true};CircleAttribute=function(t){this.perceive(t)};CircleAttribute.prototype.key="circle";CircleAttribute.prototype.targetType="obj";CircleAttribute.prototype.arity=1;CircleAttribute.prototype.constant=true;CircleAttribute.prototype.perceive=function(t){this.obj=t;this.val=CircleAttribute.circleness(t)};CircleAttribute.prototype.get_activity=function(){return this.val};CircleAttribute.prototype.get_label=function(){return this.key};CircleAttribute.circleness=function(t){if(t instanceof Circle)return 1;else return 0};SquareAttribute=function(t){this.perceive(t)};SquareAttribute.prototype.key="square";SquareAttribute.prototype.targetType="obj";SquareAttribute.prototype.arity=1;SquareAttribute.prototype.constant=true;SquareAttribute.prototype.perceive=function(t){this.obj=t;this.val=SquareAttribute.squareness(t)};SquareAttribute.prototype.get_activity=function(){return this.val};SquareAttribute.prototype.get_label=function(){return this.key};SquareAttribute.squareness=function(t){if(t instanceof Polygon){if(!t.closed)return 0;t.order_vertices();if(SquareAttribute.isRectangle(t)){var e=t.get_edge_lengths(true);if(e[0]/e[3]<.7)return.3;else return 1}}return 0};SquareAttribute.isRectangle=function(t){if(t.pts.length!=4)return false;var e=110*Math.PI/180,i=70*Math.PI/180;for(var o=0;o<t.pts.length;++o){if(t.angle(o)>e||t.angle(o)<i)return false}return true};RectangleAttribute=function(t){this.perceive(t)};RectangleAttribute.prototype.key="rect";RectangleAttribute.prototype.targetType="obj";RectangleAttribute.prototype.arity=1;RectangleAttribute.prototype.constant=true;RectangleAttribute.prototype.perceive=function(t){this.obj=t;this.val=RectangleAttribute.rectness(t)};RectangleAttribute.prototype.get_activity=function(){return this.val};RectangleAttribute.prototype.get_label=function(){return this.key};RectangleAttribute.rectness=function(t){if(t instanceof Polygon){if(!t.closed)return 0;t.order_vertices();if(RectangleAttribute.isRectangle(t)){var e=t.get_edge_lengths(true);if(e[0]/e[3]<.7)return 1;else return.4}}return 0};RectangleAttribute.isRectangle=function(t){if(t.pts.length!=4)return false;var e=110*Math.PI/180,i=70*Math.PI/180;for(var o=0;o<t.pts.length;++o){if(t.angle(o)>e||t.angle(o)<i)return false}return true};TriangleAttribute=function(t){this.perceive(t)};TriangleAttribute.prototype.key="triangle";TriangleAttribute.prototype.targetType="obj";TriangleAttribute.prototype.arity=1;TriangleAttribute.prototype.constant=true;TriangleAttribute.prototype.perceive=function(t){this.obj=t;this.val=TriangleAttribute.triangleness(t)};TriangleAttribute.prototype.get_activity=function(){return this.val};TriangleAttribute.prototype.get_label=function(){return this.key};TriangleAttribute.triangleness=function(t){if(t instanceof Polygon&&t.closed&&t.pts.length===3)return 1;return 0};MovesAttribute=function(t){this.perceive(t)};MovesAttribute.prototype.key="moves";MovesAttribute.prototype.targetType="obj";MovesAttribute.prototype.arity=1;MovesAttribute.prototype.constant=true;MovesAttribute.membership=function(t){var e=40;var i=.1;return 1/(1+Math.exp(e*(i-t)))};MovesAttribute.prototype.perceive=function(t){this.obj=t;var e=t.phys_obj;this.val=e.m_linearVelocity.Length();t.object_node.scene_node.oracle.analyzeFuture(.1,null,function(){this.val_soon=e.m_linearVelocity.Length()}.bind(this))};MovesAttribute.prototype.get_activity=function(){return Math.max(MovesAttribute.membership(this.val),MovesAttribute.membership(this.val_soon))};MovesAttribute.prototype.get_label=function(){return"moves"};SmallAttribute=function(t){this.perceive(t)};SmallAttribute.prototype.key="small";SmallAttribute.prototype.targetType="obj";SmallAttribute.prototype.arity=1;SmallAttribute.prototype.constant=true;SmallAttribute.membership=function(t){var e=4;var i=1.8;var o=100;return 1-1/(1+Math.exp(e*(i-t/o/o*100)))};SmallAttribute.prototype.perceive=function(t){this.obj=t;this.val=Math.abs(t.area())};SmallAttribute.prototype.get_activity=function(){return SmallAttribute.membership(this.val)};SmallAttribute.prototype.get_label=function(){return"small"};LargeAttribute=function(t){this.perceive(t)};LargeAttribute.prototype.key="large";LargeAttribute.prototype.targetType="obj";LargeAttribute.prototype.arity=1;LargeAttribute.prototype.constant=true;LargeAttribute.membership=function(t){var e=4;var i=2;var o=100;return 1/(1+Math.exp(e*(i-t/o/o*100)))};LargeAttribute.prototype.perceive=function(t){this.obj=t;this.val=Math.abs(t.area())};LargeAttribute.prototype.get_activity=function(){return LargeAttribute.membership(this.val)};LargeAttribute.prototype.get_label=function(){return"large"};LeftAttribute=function(t){this.perceive(t)};LeftAttribute.prototype.key="left_pos";LeftAttribute.prototype.targetType="obj";LeftAttribute.prototype.arity=1;LeftAttribute.prototype.size=100;LeftAttribute.prototype.constant=false;LeftAttribute.prototype.membership=function(t){return 1-1/(1+Math.exp(20*(.4-t/this.size)))};LeftAttribute.prototype.perceive=function(t){this.obj=t;this.val=t.x};LeftAttribute.prototype.get_activity=function(){return this.membership(this.val)};LeftAttribute.prototype.get_label=function(){return"left"};LeftMostAttribute=function(t){this.adaptDomain(t.object_node.scene_node.objs);this.perceive(t)};LeftMostAttribute.prototype.key="left_most";LeftMostAttribute.prototype.targetType="obj";LeftMostAttribute.prototype.arity=1;LeftMostAttribute.prototype.constant=false;LeftMostAttribute.prototype.adaptDomain=function(t){var e,i=null;for(var o=0;o<t.length;o++){if(!(t[o]instanceof ObjectNode))continue;var r=t[o].obj.phys_obj.GetPosition().x;if(!i||e>r){i=t[o];e=r}}this.leftmost_x=i.obj.x};LeftMostAttribute.prototype.membership=function(t){return CloseRelationship.membership(2.5*Math.abs(this.val-this.leftmost_x))};LeftMostAttribute.prototype.perceive=function(t){this.obj=t;this.val=t.x};LeftMostAttribute.prototype.get_activity=function(){return this.membership(this.val)};LeftMostAttribute.prototype.get_label=function(){return"left-most"};RightAttribute=function(t){this.perceive(t)};RightAttribute.prototype.key="right_pos";RightAttribute.prototype.targetType="obj";RightAttribute.prototype.arity=1;RightAttribute.prototype.size=100;RightAttribute.prototype.constant=false;RightAttribute.prototype.membership=function(t){return 1-1/(1+Math.exp(20*(.4-t/this.size)))};RightAttribute.prototype.perceive=function(t){this.obj=t;this.val=this.size-t.x};RightAttribute.prototype.get_activity=function(){return this.membership(this.val)};RightAttribute.prototype.get_label=function(){return"right"};RightMostAttribute=function(t){this.adaptDomain(t.object_node.scene_node.objs);this.perceive(t)};RightMostAttribute.prototype.key="right_most";RightMostAttribute.prototype.targetType="obj";RightMostAttribute.prototype.arity=1;RightMostAttribute.prototype.constant=false;RightMostAttribute.prototype.adaptDomain=function(t){var e,i=null;for(var o=0;o<t.length;o++){if(!(t[o]instanceof ObjectNode))continue;var r=t[o].obj.phys_obj.GetPosition().x;if(!i||e<r){i=t[o];e=r}}this.rightmost_x=i.obj.x};RightMostAttribute.prototype.membership=function(t){return CloseRelationship.membership(2.5*Math.abs(this.val-this.rightmost_x))};RightMostAttribute.prototype.perceive=function(t){this.obj=t;this.val=t.x};RightMostAttribute.prototype.get_activity=function(){return this.membership(this.val)};RightMostAttribute.prototype.get_label=function(){return"right-most"};BottomAttribute=function(t){this.adaptDomain(t.object_node.scene_node.ground);this.perceive(t)};BottomAttribute.prototype.key="bottom_pos";BottomAttribute.prototype.targetType="obj";BottomAttribute.prototype.arity=1;BottomAttribute.prototype.constant=false;BottomAttribute.prototype.adaptDomain=function(t){var e=t.bounding_box();this.maxy=t.y+e.y+e.height};BottomAttribute.prototype.membership=function(t){return 1-1/(1+Math.exp(20*(.3-t/this.maxy)))};BottomAttribute.prototype.perceive=function(t){this.obj=t;this.val=this.maxy-t.y};BottomAttribute.prototype.get_activity=function(){return this.membership(this.val)};BottomAttribute.prototype.get_label=function(){return"bottom"};SingleAttribute=function(t){this.perceive(t)};SingleAttribute.prototype.key="single";SingleAttribute.prototype.targetType="obj";SingleAttribute.prototype.arity=1;SingleAttribute.prototype.constant=false;SingleAttribute.membership=function(t){var e=40;var i=.03;var o=100;return 1/(1+Math.exp(e*(i-t/o)))};SingleAttribute.prototype.perceive=function(t){this.obj=t;var e=t.object_node.scene_node.oracle.getClosestBodyWithDist(t.phys_obj);if(!e)this.val=100;else this.val=e.dist/t.phys_scale};SingleAttribute.prototype.get_activity=function(){return Math.max(0,SingleAttribute.membership(this.val)-TouchRelationship.membership(this.val))};SingleAttribute.prototype.get_label=function(){return"single"};TopAttribute=function(t){this.adaptDomain(t.object_node.scene_node.ground);this.perceive(t)};TopAttribute.prototype.key="top_pos";TopAttribute.prototype.targetType="obj";TopAttribute.prototype.arity=1;TopAttribute.prototype.constant=false;TopAttribute.prototype.adaptDomain=function(t){if(t){var e=t.bounding_box();this.maxy=t.y+e.y+e.height}else{this.maxy=100}};TopAttribute.prototype.membership=function(t){return 1-1/(1+Math.exp(20*(.45-t/this.maxy)))};TopAttribute.prototype.perceive=function(t){this.obj=t;this.val=t.y};TopAttribute.prototype.get_activity=function(){return this.membership(this.val)};TopAttribute.prototype.get_label=function(){return"top"};TopMostAttribute=function(t){this.adaptDomain(t.object_node.scene_node.objs);this.perceive(t)};TopMostAttribute.prototype.key="top_most";TopMostAttribute.prototype.targetType="obj";TopMostAttribute.prototype.arity=1;TopMostAttribute.prototype.constant=false;TopMostAttribute.prototype.adaptDomain=function(t){var e,i=null;for(var o=0;o<t.length;o++){if(!(t[o]instanceof ObjectNode))continue;var r=t[o].obj.phys_obj.GetPosition().y;if(!i||e>r){i=t[o];e=r}}this.topmost_y=i.obj.y};TopMostAttribute.prototype.membership=function(t){return CloseRelationship.membership(2.5*Math.abs(this.val-this.topmost_y))};TopMostAttribute.prototype.perceive=function(t){this.obj=t;this.val=t.y};TopMostAttribute.prototype.get_activity=function(){return this.membership(this.val)};TopMostAttribute.prototype.get_label=function(){return"top-most"};OnGroundAttribute=function(t){this.ground=t.object_node.scene_node.ground;this.perceive(t)};OnGroundAttribute.prototype.key="on_ground";OnGroundAttribute.prototype.targetType="obj";OnGroundAttribute.prototype.arity=1;OnGroundAttribute.prototype.constant=false;OnGroundAttribute.prototype.perceive=function(t){this.obj=t;var e=t.object_node.getRel("touch",{other:this.ground.object_node});this.val=e.get_activity()};OnGroundAttribute.prototype.get_activity=function(){return this.val=="?"?0:this.val};OnGroundAttribute.prototype.get_label=function(){return"on-ground"};LeftRelationship=function(t,e){this.perceive(t,e)};LeftRelationship.prototype.key="left_of";LeftRelationship.prototype.arity=2;LeftRelationship.prototype.targetType="obj";LeftRelationship.prototype.symmetry=false;LeftRelationship.prototype.constant=false;LeftRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=SpatialRelationAnalyzer(100,100/2/100,"left").getMembership(t,e);var o=SpatialRelationAnalyzer(100,100/2/100,"right").getMembership(t,e);this.val=Math.max(0,i[1]-o[1])};LeftRelationship.prototype.get_activity=function(){if(this.val=="?")return 0;return this.val};LeftRelationship.prototype.get_label=function(){return"left-of"};RightRelationship=function(t,e){this.perceive(t,e)};RightRelationship.prototype.key="right_of";RightRelationship.prototype.targetType="obj";RightRelationship.prototype.arity=2;RightRelationship.prototype.symmetry=false;RightRelationship.prototype.constant=false;RightRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=SpatialRelationAnalyzer(100,100/2/100,"left").getMembership(t,e);var o=SpatialRelationAnalyzer(100,100/2/100,"right").getMembership(t,e);this.val=Math.max(0,o[1]-i[1])};RightRelationship.prototype.get_activity=function(){if(this.val=="?")return 0;return this.val};RightRelationship.prototype.get_label=function(){return"right-of"};BesideRelationship=function(t,e){this.perceive(t,e)};BesideRelationship.prototype.key="beside";BesideRelationship.prototype.targetType="obj";BesideRelationship.prototype.arity=2;BesideRelationship.prototype.symmetric=true;BesideRelationship.prototype.constant=false;BesideRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=SpatialRelationAnalyzer(100,100/2/100,"left").getMembership(t,e);var o=SpatialRelationAnalyzer(100,100/2/100,"right").getMembership(t,e);var r=Math.max(0,i[1]-o[1]);var n=Math.max(0,o[1]-i[1]);this.val=Math.max(r,n)};BesideRelationship.prototype.get_activity=function(){return this.val=="?"?0:this.val};BesideRelationship.prototype.get_label=function(){return"beside"};BelowRelationship=function(t,e){this.perceive(t,e)};BelowRelationship.prototype.key="below";BelowRelationship.prototype.targetType="obj";BelowRelationship.prototype.arity=2;BelowRelationship.prototype.symmetry=false;BelowRelationship.prototype.constant=false;BelowRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=SpatialRelationAnalyzer(100,100/2/100,"above").getMembership(t,e);var o=SpatialRelationAnalyzer(100,100/2/100,"below").getMembership(t,e);this.val=Math.max(0,o[1]-i[1])};BelowRelationship.prototype.get_activity=function(){if(this.val=="?")return 0;else return this.val};BelowRelationship.prototype.get_label=function(){return"below"};AboveRelationship=function(t,e){this.perceive(t,e)};AboveRelationship.prototype.key="above";AboveRelationship.prototype.targetType="obj";AboveRelationship.prototype.arity=2;AboveRelationship.prototype.symmetry=false;AboveRelationship.prototype.constant=false;AboveRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=SpatialRelationAnalyzer(100,100/2/100,"above").getMembership(t,e);var o=SpatialRelationAnalyzer(100,100/2/100,"below").getMembership(t,e);this.val_max=i[2];this.val_min=i[0];this.val=Math.max(0,i[1]-o[1])};AboveRelationship.prototype.get_activity=function(){if(this.val=="?")return 0;else return this.val};AboveRelationship.prototype.get_label=function(){return"above"};TouchRelationship=function(t,e){this.perceive(t,e)};TouchRelationship.prototype.key="touch";TouchRelationship.prototype.targetType="obj";TouchRelationship.prototype.arity=2;TouchRelationship.prototype.symmetric=true;TouchRelationship.prototype.constant=false;TouchRelationship.membership=function(t){return t<=.5?1:0};TouchRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.val=t.phys_obj.distance(e.phys_obj)/t.phys_scale};TouchRelationship.prototype.get_activity=function(){return TouchRelationship.membership(this.val)};TouchRelationship.prototype.get_label=function(){return"touches"};OnTopRelationship=function(t,e){this.perceive(t,e)};OnTopRelationship.prototype.key="on_top_of";OnTopRelationship.prototype.targetType="obj";OnTopRelationship.prototype.arity=2;OnTopRelationship.prototype.symmetric=false;OnTopRelationship.prototype.constant=false;OnTopRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;var i=t.object_node.getRel("touch",{other:e.object_node}).get_activity();var o=Math.max(t.object_node.getRel("above",{other:e.object_node}).get_activity(),e.object_node.getRel("below",{other:t.object_node}).get_activity());this.val=i*o};OnTopRelationship.prototype.get_activity=function(){return this.val=="?"?0:this.val};OnTopRelationship.prototype.get_label=function(){return"on-top-of"};FarRelationship=function(t,e){this.perceive(t,e)};FarRelationship.prototype.key="far";FarRelationship.prototype.targetType="obj";FarRelationship.prototype.arity=2;FarRelationship.prototype.symmetric=true;FarRelationship.prototype.constant=false;FarRelationship.membership=function(t){var e=20;var i=.25;var o=100;return 1/(1+Math.exp(e*(i-t/o)))};FarRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.val=t.phys_obj.distance(e.phys_obj)/t.phys_scale};FarRelationship.prototype.get_activity=function(){return FarRelationship.membership(this.val)};FarRelationship.prototype.get_label=function(){return"far"};FarAttribute=function(t){this.perceive(t)};FarAttribute.prototype.key="far";FarAttribute.prototype.targetType="group";FarAttribute.prototype.arity=1;FarAttribute.prototype.constant=false;FarAttribute.prototype.perceive=function(t){this.group=t;if(t.objs.length<2)this.val=NaN;else{this.val=Infinity;for(var e=1;e<t.objs.length;e++)for(var i=0;i<e;i++){var o=t.objs[e].phys_obj.distance(t.objs[i].phys_obj)/t.objs[0].phys_scale;if(this.val>o)this.val=o}}};FarAttribute.prototype.get_activity=function(){return isNaN(this.val)?0:FarRelationship.membership(this.val)};FarAttribute.prototype.get_label=function(){return"far"};CloseRelationship=function(t,e){this.perceive(t,e)};CloseRelationship.prototype.key="close";CloseRelationship.prototype.targetType="obj";CloseRelationship.prototype.arity=2;CloseRelationship.prototype.symmetric=true;CloseRelationship.prototype.constant=false;CloseRelationship.membership=function(t){var e=30;var i=.2;var o=100;return 1-1/(1+Math.exp(e*(i-t/o)))};CloseRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;if(t.object_node.scene_node===e.object_node.scene_node){this.val=t.phys_obj.distance(e.phys_obj)/t.phys_scale}else{this.val=Point.len(t.x-e.x,t.y-e.y)*2/3}};CloseRelationship.prototype.get_activity=function(){return CloseRelationship.membership(this.val)};CloseRelationship.prototype.get_label=function(){return"close"};CloseAttribute=function(t){this.perceive(t)};CloseAttribute.prototype.key="close";CloseAttribute.prototype.targetType="group";CloseAttribute.prototype.arity=1;CloseAttribute.prototype.constant=false;CloseAttribute.prototype.perceive=function(t){this.group=t;if(t.objs.length<2)this.val=NaN;else{var e=[];for(var i=0;i<t.objs.length;i++){e.push(i)}var o=[],r=t.objs[0].phys_scale;for(var i=1;i<t.objs.length;i++)for(var n=0;n<i;n++){o.push({a:i,b:n,dist:t.objs[i].phys_obj.distance(t.objs[n].phys_obj)/r})}var s=CloseAttribute.getMST(e,o);this.val=s[s.length-1].dist}};CloseAttribute.prototype.get_activity=function(){return isNaN(this.val)?0:CloseRelationship.membership(this.val)};CloseAttribute.prototype.get_label=function(){return"close"};CloseAttribute.getMST=function(t,e){var i=[];var o=t.map(function(t){var e={};e[t]=true;return e});e.sort(function(t,e){return t.dist-e.dist});for(var r=0;r<e.length;r++){var n=e[r].a,s=e[r].b;var a,p;for(var h=0;h<o.length;h++){if(n in o[h])a=h;if(s in o[h])p=h}if(a===p)continue;i.push(e[r]);for(var l in o[p])o[a][l]=true;o[p]={}}return i};HitsRelationship=function(t,e){this.perceive(t,e)};HitsRelationship.prototype.key="hits";HitsRelationship.prototype.targetType="obj";HitsRelationship.prototype.arity=2;HitsRelationship.prototype.symmetric=false;HitsRelationship.prototype.constant=true;HitsRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.collisions=t.object_node.scene_node.collisions.filter(function(i){return i.a===t&&i.b===e});this.val=this.collisions.length==0?0:d3.max(this.collisions,function(t){return t.dv})};HitsRelationship.prototype.get_activity=function(){return this.val==0?0:1};HitsRelationship.prototype.get_label=function(){return"hits"};GetsHitRelationship=function(t,e){this.perceive(t,e)};GetsHitRelationship.prototype.key="gets_hit";GetsHitRelationship.prototype.targetType="obj";GetsHitRelationship.prototype.arity=2;GetsHitRelationship.prototype.symmetric=false;GetsHitRelationship.prototype.constant=true;GetsHitRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.collisions=t.object_node.scene_node.collisions.filter(function(i){return i.b===t&&i.a===e});this.val=this.collisions.length==0?0:d3.max(this.collisions,function(t){return t.dv})};GetsHitRelationship.prototype.get_activity=function(){return this.val==0?0:1};GetsHitRelationship.prototype.get_label=function(){return"gets-hit-by"};CollidesRelationship=function(t,e){this.perceive(t,e)};CollidesRelationship.prototype.key="collides";CollidesRelationship.prototype.targetType="obj";CollidesRelationship.prototype.arity=2;CollidesRelationship.prototype.symmetric=true;CollidesRelationship.prototype.constant=true;CollidesRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.collisions=t.object_node.scene_node.collisions.filter(function(i){return i.a===t&&i.b===e||i.b===t&&i.a===e});this.val=this.collisions.length==0?0:d3.max(this.collisions,function(t){return t.dv})};CollidesRelationship.prototype.get_activity=function(){return this.val==0?0:1};CollidesRelationship.prototype.get_label=function(){return"collides-with"};SupportsRelationship=function(t,e){this.perceive(t,e)};SupportsRelationship.prototype.key="supports";SupportsRelationship.prototype.targetType="obj";SupportsRelationship.prototype.arity=2;SupportsRelationship.prototype.symmetry=false;SupportsRelationship.prototype.constant=false;SupportsRelationship.prototype.perceive=function(t,e){this.obj=t;this.other=e;this.val=this.checkSupports(t.object_node,e.object_node,t.object_node.scene_node.oracle)};SupportsRelationship.prototype.get_activity=function(){if(this.val=="directly")return 1;if(this.val=="indirectly")return.7;if(this.val=="stabilizes")return.4;if(this.val=="not")return 0;throw"unknown support value"};SupportsRelationship.prototype.get_label=function(){return"supporting"};SupportsRelationship.prototype.checkSupports=function(t,e,i){var o=.5,r=.5,n=.5,s=.5;if(t===e)return"not";if(e.getAttr("moves").get_activity()>o)return"not";var a=t.getRel("touch",{other:e}).get_activity()>r;var p=t.obj.phys_obj;var h=function(){i.pscene.wakeUp();p.SetActive(false)};var l=i.analyzeFuture(0,h,function(){var t=new MovesAttribute(e.obj);return t.get_activity()>o});if(l)return a?"directly":"indirectly";var u=e.getRel("on_top_of",{other:t}).get_activity()>n;if(u)return"stabilizes";var c=t.getRel("close",{other:e}).get_activity()>s;if(c){var b=e.getAttr("stability").get_label()=="stable";if(b){var y=i.analyzeFuture(0,h,function(){var t=new StabilityAttribute(e.obj);return t.get_label()=="stable"});if(!y)return"stabilizes"}}return"not"};CountAttribute=function(t){this.perceive(t)};CountAttribute.prototype.key="count";CountAttribute.prototype.targetType="group";CountAttribute.prototype.arity=1;CountAttribute.prototype.constant=true;CountAttribute.prototype.perceive=function(t){this.group=t;this.val=t.objs.length};CountAttribute.prototype.get_activity=function(){return 1};CountAttribute.prototype.get_label=function(){if(this.val<4)return this.val;return">=4"};TouchAttribute=function(t){this.perceive(t)};TouchAttribute.prototype.key="touching";TouchAttribute.prototype.targetType="group";TouchAttribute.prototype.arity=1;TouchAttribute.prototype.constant=false;TouchAttribute.prototype.perceive=function(t){this.group=t;if(t.objs.length<2)this.val=100;else{var e=[];for(var i=0;i<t.objs.length;i++){e.push(i)}var o=[],r=t.objs[0].phys_scale;for(var i=1;i<t.objs.length;i++)for(var n=0;n<i;n++){o.push({a:i,b:n,dist:t.objs[i].phys_obj.distance(t.objs[n].phys_obj)/r})}var s=CloseAttribute.getMST(e,o);this.val=s[s.length-1].dist}};TouchAttribute.prototype.get_activity=function(){return isNaN(this.val)?0:TouchRelationship.membership(this.val)};TouchAttribute.prototype.get_label=function(){return"touching"};IsSupportedAttribute=function(t){this.perceive(t)};IsSupportedAttribute.prototype.key="is_supported";IsSupportedAttribute.prototype.targetType="obj";IsSupportedAttribute.prototype.arity=1;IsSupportedAttribute.prototype.constant=false;IsSupportedAttribute.membership=function(t){var e=40;var i=.1;return 1/(1+Math.exp(e*(i-t)))};IsSupportedAttribute.prototype.perceive=function(t){var e=t.object_node.scene_node.oracle;function i(){e.pscene.forEachDynamicBody(function(e){if(e===t.phys_obj)return;e.SetType(Box2D.Dynamics.b2Body.b2_staticBody)})}function o(){this.val_soon=r.m_linearVelocity.Length()}this.obj=t;var r=t.phys_obj;this.val=r.m_linearVelocity.Length();e.analyzeFuture(.1,i,o.bind(this))};IsSupportedAttribute.prototype.get_activity=function(){return 1-Math.max(IsSupportedAttribute.membership(this.val),IsSupportedAttribute.membership(this.val_soon))};IsSupportedAttribute.prototype.get_label=function(){return"is-supported"};var pbpSettings=function(){res={max_dist:.06,activation_threshold:.5,obj_attrs:{},obj_rels:{},group_attrs:{}};[LeftAttribute,LeftMostAttribute,RightAttribute,RightMostAttribute,BottomAttribute,TopAttribute,TopMostAttribute,SingleAttribute,OnGroundAttribute,CircleAttribute,SquareAttribute,RectangleAttribute,TriangleAttribute,ShapeAttribute,StabilityAttribute,SmallAttribute,LargeAttribute,MovesAttribute,MovableUpAttribute,IsSupportedAttribute].forEach(function(t){res.obj_attrs[t.prototype.key]=t});[CloseAttribute,CountAttribute,FarAttribute,TouchAttribute].forEach(function(t){res.group_attrs[t.prototype.key]=t});[AboveRelationship,BelowRelationship,LeftRelationship,RightRelationship,BesideRelationship,FarRelationship,CloseRelationship,OnTopRelationship,TouchRelationship,HitsRelationship,GetsHitRelationship,CollidesRelationship,SupportsRelationship].forEach(function(t){res.obj_rels[t.prototype.key]=t});return res}();var PBP=PBP||{};PBP.extend=function(t,e){if(typeof e==="object")for(var i in e)t[i]=e[i];return t};GroupNode=function(t,e,i){this.scene_node=t;this.objs=e||[];this.times={};this.selectors=i?Array.isArray(i)?i.slice():[i]:[new Selector]};GroupNode.prototype.empty=function(){return this.objs.length===0};GroupNode.prototype.clone=function(){var t=new GroupNode(this.scene_node,this.objs.slice(),this.selectors);t.times=this.times;return t};GroupNode.sceneGroup=function(t,e){var i=new GroupNode(t);for(var o=0;o<t.objs.length;o++){var r=t.objs[o];if(r!=e&&r instanceof ObjectNode)i.objs.push(r.obj)}return i};GroupNode.spatialGroups=function(t,e){var i=[];if(typeof e==="undefined")e=.06;var o=t.oracle.getSpatialGroups(e);for(var r=0;r<o.length;r++){if(o[r].length>0)i.push(new GroupNode(t,o[r].map(function(t){return t.master_obj.obj})))}return i};GroupNode.attrs=pbpSettings.group_attrs;GroupNode.prototype.perceive=function(t){var e={};for(var i in GroupNode.attrs){var o=GroupNode.attrs[i];e[i]=new o(this)}this.times[t]=e};GroupNode.prototype.getAttr=function(t,e){var i=PBP.extend({},e);if(!i.time)i.time=this.scene_node.oracle.curr_state;if(GroupNode.attrs[t].constant)i.time="start";if(i.time in this.times&&t in this.times[i.time]){var o=this.times[i.time][t];return o}if(i.cache_only)return false;if(i.time)this.scene_node.oracle.gotoState(i.time);var o=new GroupNode.attrs[t](this);if(i.time){if(!this.times[i.time])this.times[i.time]={};this.times[i.time][t]=o}return o};GroupNode.prototype.getFromCache=function(t,e){e=e||{};e.cache_only=true;return this.getAttr(t,e)};GroupNode.prototype.get=GroupNode.prototype.getAttr;GroupNode.prototype.describe=function(){console.log(this)};ObjectNode=function(t,e){this.obj=e;e.object_node=this;this.scene_node=t;this.times={};this.selectors=[]};ObjectNode.attrs=pbpSettings.obj_attrs;ObjectNode.rels=pbpSettings.obj_rels;ObjectNode.prototype.hasRelation=function(t,e,i,o){if(!(e in this.times))return false;if(!(t in ObjectNode.rels)||!(t in this.times[e]))return false;return this.times[e][t].some(function(t){return t.other===o.obj&&t.get_activity()>=pbpSettings.activation_threshold==i}.bind(this))};ObjectNode.prototype.perceive=function(t){var e={};for(var i in ObjectNode.attrs){var o=ObjectNode.attrs[i];e[i]=new o(this.obj,this.scene_node)}for(var r in ObjectNode.rels){var n=ObjectNode.rels[r];e[r]=[];var s=this.scene_node.objs;for(var a=0;a<s.length;a++){if(s[a]==this)continue;if(typeof GroupNode!="undefined"&&s[a]instanceof GroupNode){if(n.ObjectToGroup)e[r].push(n.ObjectToGroup(this.obj,s[a].objs,this.scene_node))}else if(s[a]instanceof ObjectNode){e[r].push(new n(this.obj,s[a].obj,this.scene_node))}}if(e[r].length==0)delete e[r]}this.times[t]=e};ObjectNode.prototype.get=function(t,e){if(t in ObjectNode.attrs)return this.getAttr(t,e);else if(t in ObjectNode.rels)return this.getRel(t,e);else throw"unknown feature '"+t+"'"};ObjectNode.prototype.getFromCache=function(t,e){e=e||{};e.cache_only=true;return this.get(t,e)};ObjectNode.prototype.getAttr=function(t,e){var i=PBP.extend({},e);if(!i.time)i.time=this.scene_node.oracle.curr_state;if(ObjectNode.attrs[t].constant)i.time="start";if(i.time in this.times&&t in this.times[i.time]){var o=this.times[i.time][t];return o}if(i.cache_only)return false;if(i.time)this.scene_node.oracle.gotoState(i.time);var o=new ObjectNode.attrs[t](this.obj);if(i.time){if(!this.times[i.time])this.times[i.time]={};
this.times[i.time][t]=o}return o};ObjectNode.prototype.getRel=function(t,e){var i=PBP.extend({},e);if(!i.time)i.time=this.scene_node.oracle.curr_state;if(ObjectNode.rels[t].constant)i.time="start";if(i.time in this.times&&t in this.times[i.time]){var o=this.times[i.time][t];if(i.get_all)return o;var r=o.filter(function(t){return t.other===i.other.obj})[0];if(r){return r}}if(i.cache_only)return i.get_all?[]:false;if(i.time)this.scene_node.oracle.gotoState(i.time);var r=new ObjectNode.rels[t](this.obj,i.other.obj);if(i.time){if(!this.times[i.time])this.times[i.time]={};if(!this.times[i.time][t])this.times[i.time][t]=[];this.times[i.time][t].push(r)}return r};ObjectNode.prototype.describe=function(t){t=t||"";var e=[t+"Obj. "+this.obj.id+":"];var i=d3.keys(this.times);for(var o in this.times)e.push(t+this.describeState(o,"  "));return e.join("\n")};ObjectNode.prototype.describeState=function(t,e){e=e||"";var i=[];for(var o in ObjectNode.attrs){var r=this.times[t][o];if(!r)continue;var n=r.get_activity()>=.5;i.push((n?"":"!")+r.get_label())}for(var s in ObjectNode.rels){var a=this.times[t][s];if(!a)continue;for(var p=0;p<a.length;p++){if(!a[p])continue;var n=a[p].get_activity()>=.5;i.push((n?"":"!")+a[p].get_label()+" "+a[p].other.id)}}return e+t+": "+i.join(", ")};SceneNode=function(t,e){this.scene=t;this.side=t.side;this.id=t.name||"s"+Math.round(Math.random()*1e4);this.oracle=e;this.objs=[];this.groups=[];this.ground=null;this.frame=null;this.collisions=[];this.times=["start","end"];this.init()};SceneNode.prototype.getAllGroup=function(){return GroupNode.sceneGroup(this)};SceneNode.prototype.init=function(){var t=[],e=this.scene.shapes;for(var i=0;i<e.length;i++){if(e[i].movable)t.push(e[i]);else if(e[i].id=="_")this.ground=e[i];else if(e[i].id=="|")this.frame=e[i]}};SceneNode.prototype.registerObjects=function(){var t=this.scene.shapes.filter(function(t){return t.movable});for(var e=0;e<t.length;e++){if(!t[e].object_node)this.objs.push(new ObjectNode(this,t[e]))}if(this.ground&&!this.ground.object_node)this.ground.object_node=new ObjectNode(this,this.ground)};SceneNode.prototype.perceiveCollisions=function(){this.oracle.gotoState("start");this.collisions=this.oracle.observeCollisions();for(var t=0;t<this.collisions.length;t++){this.collisions[t].a=this.collisions[t].a.master_obj;this.collisions[t].b=this.collisions[t].b.master_obj}};SceneNode.prototype.perceiveAll=function(){this.perceiveCollisions();for(var t=0;t<this.times.length;t++){this.oracle.gotoState(this.times[t]);this.perceiveCurrent(this.times[t])}};SceneNode.prototype.perceiveCurrent=function(t){t=t||"current";this.registerObjects();for(var e=0;e<this.objs.length;e++)this.objs[e].perceive(t)};SceneNode.prototype.describe=function(t){t=t||"";var e=[t+"Objects:"];for(var i=0;i<this.objs.length;i++){e.push(this.objs[i].describe(t+"  "))}e.push(t+"Collisions:");for(var i=0;i<this.collisions.length;i++){var o=this.collisions[i];e.push(t+"  "+o.a.id+" hits "+o.b.id)}return e.join("\n")};var Selector=function(t){this.obj_attrs=[];this.grp_attrs=[];this.rels=[];this.unique=!!t;this.cached_complexity=null};Selector.prototype.getType=function(){if(this.blank())return"object";if(this.grp_attrs.length===0)return"object";if(this.obj_attrs.length===0&&this.rels.length===0)return"group";return"mixed"};Selector.prototype.getComplexity=function(){var t=0;for(var e=0;e<this.obj_attrs.length;e++){t+=this.obj_attrs[e].getComplexity()}for(var e=0;e<this.grp_attrs.length;e++){t+=this.grp_attrs[e].getComplexity()}for(var e=0;e<this.rels.length;e++){t+=this.rels[e].getComplexity()}if(this.cached_complexity===null)this.cached_complexity=t;if(this.cached_complexity!==t)throw"cached complexity got stale!";return t};Selector.prototype.blank=function(){return this.obj_attrs.length===0&&this.grp_attrs.length===0&&this.rels.length===0};Selector.prototype.hasRelationships=function(){return this.rels.length>0};Selector.prototype.featureCount=function(){return this.obj_attrs.length+this.grp_attrs.length+this.rels.length};Selector.prototype.forEachFeature=function(t){var e;for(e=0;e<this.obj_attrs.length;e++)t(pbpSettings.obj_attrs[this.obj_attrs[e].key]);for(e=0;e<this.grp_attrs.length;e++)t(pbpSettings.group_attrs[this.grp_attrs[e].key]);for(e=0;e<this.rels.length;e++){t(pbpSettings.obj_rels[this.rels[e].key]);this.rels[e].other_sel.forEachFeature(t)}};Selector.prototype.mergedWith=function(t){var e=new Selector;var i=function(t){e.add_attr(t)};var o=function(t){e.add_rel(t)};this.obj_attrs.forEach(i);t.obj_attrs.forEach(i);this.grp_attrs.forEach(i);t.grp_attrs.forEach(i);this.rels.forEach(o);t.rels.forEach(o);return e};Selector.prototype.clone=function(){var t=new Selector(this.unique);var e=function(e){t.add_attr(e)};var i=function(e){t.add_rel(e)};this.obj_attrs.forEach(e);this.grp_attrs.forEach(e);this.rels.forEach(i);return t};Selector.prototype.use_attr=function(t,e){this.add_attr(Selector.AttrMatcher.fromAttribute(t,e));return this};Selector.prototype.add_attr=function(t){var e=t.type==="group"?this.grp_attrs:this.obj_attrs;for(var i=0;i<e.length;i++){var o=e[i];if(o.key===t.key&&o.time===t.time&&o.type===o.type){e[i]=t;return this}}e.push(t);return this};Selector.prototype.use_rel=function(t,e,i){this.add_rel(Selector.RelMatcher.fromRelationship(t,e,i));return this};Selector.prototype.add_rel=function(t){for(var e=0;e<this.rels.length;e++){var i=this.rels[e];if(i.key===t.key&&i.time==t.time&&i.other_sel.equals(t.other_sel)){this.rels[e]=t;return this}}this.rels.push(t);return this};Selector.prototype.equals=function(t){if(!t)return false;if(this===t)return true;if(this.obj_attrs.length!==t.obj_attrs.length)return false;if(this.grp_attrs.length!==t.grp_attrs.length)return false;if(this.rels.length!==t.rels.length)return false;var e=this;var i=function(i){return!e[i].every(function(e){return t[i].some(function(t){return e.equals(t)})})};if(i("grp_attrs")||i("obj_attrs")||i("rels"))return false;return true};Selector.prototype.matchesObject=function(t,e,i){return this.obj_attrs.every(function(e){return e.matches(t)})&&(i?i(t):this.rels.every(function(i){return i.matches(t,e)}))};Selector.prototype.matchesGroup=function(t){return this.grp_attrs.every(function(e){return e.matches(t)})};Selector.prototype.select=function(t,e,i){if(this.blank())return t;var o=this.mergedWith(t.selectors[0]);var r=t.clone();var n=this.getType();var s=this;r.selectors=[o];if(n==="mixed"||n==="object"){var a=r.objs.map(function(t){return t.object_node}).filter(function(t){return s.matchesObject(t,null,i)}).map(function(t){return t.obj});r=new GroupNode(e,a,o)}if(n==="mixed"||n==="group"){if(!this.matchesGroup(r))r=new GroupNode(e,[],o)}return r};Selector.prototype.applyToScene=function(t){var e=this.select(GroupNode.sceneGroup(t),t);e.selectors=[this];return e};Selector.prototype.describe=function(){if(this.blank())return this.unique?"[the object]":"(any object)";var t=this.obj_attrs.map(function(t){return t.describe()}).join(" and ");var e=this.grp_attrs.map(function(t){return t.describe()});var i=this.rels.map(function(t){return t.describe()});i=i.concat(e).join(" and ");if(this.unique)return"[the "+t+" object"+(i===""?"":" that is "+i)+"]";return"("+t+" objects"+(i===""?"":" that are "+i)+")"};Selector.prototype.describe2=function(t){if(this.blank()){if(t)return"*";return this.unique?"there is exactly one object":"any object"}var e=this.obj_attrs.map(function(t){return t.describe()});var i=this.grp_attrs.map(function(t){return t.describe()}).join(" and ");var o=this.rels.map(function(t){return t.describe()});var r=e.concat(o).concat(i).join(" and ");if(t){if(this.unique)return"[that is "+r+"]";else return"[that are "+r+"]"}else{if(this.unique)return"[exactly one object is "+r+"]";else return"(objects that are "+r+")"}};Selector.AttrMatcher=function(t,e,i,o,r){this.key=t;this.label=e;this.active=typeof i==="undefined"?true:i;if(t in pbpSettings.obj_attrs){this.type="object";this.constant=pbpSettings.obj_attrs[t].prototype.constant}else{this.type="group";this.constant=pbpSettings.group_attrs[t].prototype.constant}this.time=o||"start"};Selector.AttrMatcher.prototype.clone=function(){return new Selector.AttrMatcher(this.key,this.label,this.active,this.time,this.type)};Selector.AttrMatcher.fromAttribute=function(t,e){return new Selector.AttrMatcher(t.key,t.get_label(),t.get_activity()>=pbpSettings.activation_threshold,e)};Selector.AttrMatcher.prototype.getComplexity=function(){var t=1;if(this.time!=="start")t++;if(!this.active)t+=2;return t};Selector.AttrMatcher.prototype.equals=function(t){return this.key===t.key&&this.label===t.label&&this.active===t.active&&this.time===t.time};Selector.AttrMatcher.prototype.matches=function(t){var e=t.getAttr(this.key,{time:this.time});if(!e)return false;var i=e.get_activity()>=pbpSettings.activation_threshold;return i==this.active&&e.get_label()==this.label};Selector.AttrMatcher.prototype.describe=function(){return(this.active?"":"not ")+this.label+(this.constant||this.time=="start"?"":" at the "+this.time)};Selector.RelMatcher=function(t,e,i,o,r){this.other_sel=t;this.key=e;this.label=i;this.active=typeof o==="undefined"?true:o;this.constant=pbpSettings.obj_rels[e].prototype.constant;this.symmetric=pbpSettings.obj_rels[e].prototype.symmetric;this.time=r||"start"};Selector.RelMatcher.prototype.clone=function(){return new Selector.RelMatcher(this.other_sel,this.key,this.label,this.active,this.time)};Selector.RelMatcher.prototype.getComplexity=function(){var t=1;if(this.time!=="start")t++;if(!this.active)t+=2;t+=this.other_sel.getComplexity();return t};Selector.RelMatcher.prototype.equals=function(t){return this.key===t.key&&this.label===t.label&&this.active===t.active&&this.time===t.time&&this.other_sel.equals(t.other_sel)};Selector.RelMatcher.prototype.matches=function(t,e){if(this.other_sel.rels.length>0)throw"the other-selector of";e=e||t.scene_node.objs.filter(function(e){return e!==t});var i=this;var o=function(e){if(e===t)return false;var o=t.getRel(i.key,{other:e,time:i.time});if(!o)return false;var r=o.get_activity()>=pbpSettings.activation_threshold;return r==i.active&&o.get_label()==i.label};var r=function(t){return i.other_sel.matchesObject(t,null,o)};var n=e.filter(r);if(!this.active)return n.length===e.length;if(this.other_sel.unique&&n.length!=1)return false;return n.length>0};Selector.RelMatcher.fromRelationship=function(t,e,i){return new Selector.RelMatcher(t,e.key,e.get_label(),e.get_activity()>=pbpSettings.activation_threshold,i)};Selector.RelMatcher.prototype.describe=function(){return(this.active?"":"not ")+this.label+" "+this.other_sel.describe()+(this.constant||this.time=="start"?"":" at the "+this.time)};Solution=function(t,e,i){this.sel=t;this.mode=i||"exists";this.setMainSide(e);this.matchedAgainst=[];this.lchecks=0;this.rchecks=0;this.lmatches=0;this.rmatches=0;this.scene_pair_count=8;this.selects_single_objs=true};Solution.prototype.setMainSide=function(t){this.main_side=t||"both";this.other_side={left:"right",right:"left"}[this.main_side];return this};Solution.prototype.wasMatchedAgainst=function(t){return this.matchedAgainst.indexOf(t)!==-1};Solution.prototype.isSolution=function(){return this.rmatches===0&&this.lmatches==this.scene_pair_count||this.lmatches===0&&this.rmatches==this.scene_pair_count};Solution.prototype.compatibleWith=function(t){if(this.lmatches<this.lchecks&&t.rmatches<t.rchecks)return false;if(this.rmatches<this.rchecks&&t.lmatches<t.lchecks)return false;return true};Solution.prototype.checkScenePair=function(t,e){var i=this;var o=[];t.forEach(function(t){var e=i.sel.applyToScene(t);o.push(e);if(e.objs.length>1)i.selects_single_objs=false;var r=!e.empty();if(t.side==="left"){i.lchecks++;if(r)i.lmatches++}if(t.side==="right"){i.rchecks++;if(r)i.rmatches++}});this.matchedAgainst.push(e);if(this.lmatches===0&&this.rmatches===this.rchecks)this.setMainSide("right");else if(this.rmatches===0&&this.lmatches===this.lchecks)this.setMainSide("left");else if(this.lmatches>0&&this.rmatches===this.rchecks)this.setMainSide("both");else if(this.rmatches>0&&this.lmatches===this.lchecks)this.setMainSide("both");else this.setMainSide("fail");return o};Solution.prototype.check=function(t,e){if(this.side!=="left"&&this.side!=="right")return false;var i=this.main_side=="left"?t:e,o=this.main_side=="right"?t:e;return i.every(this.check_scene.bind(this))&&!o.some(this.check_scene.bind(this))};Solution.prototype.equals=function(t){return this.mode===t.mode&&this.sel.equals(t.sel)};Solution.prototype.mergedWith=function(t){var e=this.mode===t.mode?e:"exists";var i;if(t.main_side===this.main_side)i=this.main_side;else if(this.main_side==="both")i=t.main_side;else if(t.main_side==="both")i=this.main_side;else return null;return new Solution(this.sel.mergedWith(t.sel),i,e)};Solution.prototype.clone=function(){return new Solution(this.sel.clone(),this.main_side,this.mode)};Solution.prototype.applyToScene=function(t){if(this.main_side==="left"&&t.side!=="left")return new GroupNode(null,[],this.sel);if(this.main_side==="right"&&t.side!=="right")return new GroupNode(null,[],this.sel);return this.sel.applyToScene(t)};Solution.prototype.check_scene=function(t){var e=GroupNode.sceneGroup(t);var i=this.sel.select(e,t);var o=i.objs.length;var r=false;if(this.mode=="unique"&&o==1)r=1;else if(this.mode=="exists"&&o>0)r=o;else if(this.mode=="all"&&o>0&&e.objs.length==o)r=o;t.fits_solution=!!r;return r};Solution.prototype.describe=function(){var t="";if(this.main_side)t+=this.main_side==="both"?"In all scenes, ":"Only in the "+this.main_side+" scenes, ";t+=this.mode+": "+this.sel.describe();return t};